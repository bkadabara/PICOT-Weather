<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PICOT Weather Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --picot-blue:#2E3192;
      --picot-green:#00A651;
      --accent-hover:#ED1C24;
      --card-hover:#00A651;
      --bg:#F5F5F5;
      --text:#111;
    }
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
    }
    header {
      background: var(--picot-blue);
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    #logo { width: 120px; display:block; margin: 0 auto 8px; }
    h1 { margin: 0; font-size: 26px; }
    .org-name {
      margin-top: 6px;
      font-weight: 800;
      color: #fff;
      font-size: 15px;
      letter-spacing: 0.2px;
    }
    main {
      padding: 20px;
      text-align: center;
      max-width: 1100px;
      margin: 0 auto;
    }
    .controls { margin-bottom: 12px; display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:8px; }
    .label-top {
      width:100%;
      max-width:1100px;
      margin: 6px auto 0;
      font-size:15px;
      color:#333;
      text-align:left;
      padding:0 6px;
    }
    .controls-left { display:flex; gap:8px; align-items:center; }
    input[type="text"] {
      padding: 10px;
      margin: 0;
      width: 180px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 18px;
      background: var(--picot-green);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 6px;
      transition: background .18s ease, transform .12s ease;
    }
    button:hover { background: var(--accent-hover); transform: translateY(-1px); }
    #map { margin-top: 14px; border-radius: 8px; overflow: hidden; }
    #static-map { display:none; width:100%; height:auto; border-radius:8px; }

    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 95%;
      max-width: 1000px;
      background: #fff;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.06);
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      border-bottom: 1px solid #e6e6e6;
      padding: 10px 12px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: var(--picot-blue);
      color: #fff;
      font-weight: 600;
    }
    tr:nth-child(even) td { background: #fbfbfb; }
    #daily-cards {
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:12px;
      margin: 12px auto 28px;
      max-width: 1100px;
    }
    .card {
      background:#fff;
      border-radius:14px;
      box-shadow: 2px 6px 18px rgba(0,0,0,0.08);
      margin: 6px;
      padding: 14px;
      width: 160px;
      min-height: 170px;
      transition: background .28s ease, transform .18s ease, color .18s ease;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      text-align:center;
      cursor:default;
    }
    .card .icon { font-size:36px; margin-bottom:8px; }
    .card h4 { margin:6px 0 4px; font-size:16px; color:var(--picot-blue); }
    .card p { margin:4px 0; font-size:13px; color:#333; }
    .card:hover {
      background: var(--card-hover);
      color: #fff;
      transform: translateY(-6px) scale(1.03);
    }
    .card:hover h4 { color: #fff; }
    footer {
      background: var(--picot-blue);
      color: #fff;
      text-align: center;
      padding: 12px;
      margin-top: 28px;
    }
    @media (max-width:640px){
      input[type="text"]{ width: 140px; }
      .card { width: 140px; min-height:150px; }
      th, td { font-size:13px; padding:8px; }
      .label-top { font-size:13px; }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
</head>
<body>
  <header>
    <img id="logo" src="picot-logo.png" alt="PICOT Logo" />
    <h1>PICOT Weather Tracker</h1>
    <div class="org-name">Partners in Development and Center for Holistic Transformation (PICOT)</div>
  </header>

  <main id="report">
    <div class="label-top">Enter coordinates</div>

    <div class="controls" aria-hidden="false">
      <div class="controls-left">
        <label for="lat" style="display:none">Latitude</label>
        <input type="text" id="lat" placeholder="Latitude (e.g., 3.41666670)" />
        <label for="lon" style="display:none">Longitude</label>
        <input type="text" id="lon" placeholder="Longitude (e.g., 30.91105)" />
      </div>

      <div class="controls-right">
        <button id="getBtn" onclick="getWeather()">Get Forecast</button>
        <button onclick="downloadCSV()">Download as CSV</button>
        <button onclick="downloadPDF()">Download as PDF</button>
      </div>
    </div>

    <div id="map" aria-hidden="false"></div>
    <img id="static-map" alt="Static map snapshot for PDF" />

    <h2 style="margin-top:18px">3-Hourly Forecast (Next 5 Entries)</h2>
    <table id="hourly-table" role="table" aria-label="3-hourly forecast">
      <thead>
        <tr>
          <th>Time</th>
          <th>Cloud Condition</th>
          <th>Temperature (¬∞C)</th>
          <th>Humidity (%)</th>
          <th>Wind</th>
          <th>Chance of Rain (%)</th>
          <th>Precipitation (mm)</th>
        </tr>
      </thead>
      <tbody id="forecast-table"></tbody>
    </table>

    <h2 style="margin-top:18px">5-Day Forecast (Daily Summary)</h2>
    <div id="daily-cards" aria-live="polite"></div>
  </main>

  <footer>&copy; 2026 PICOT | Weather Tracker App</footer>

  <script>
    let lastDailySummary = [];

    function getWindDirection(deg) {
      if (deg === undefined || deg === null || isNaN(deg)) return "";
      const dirs = ["N","NE","E","SE","S","SW","W","NW"];
      return dirs[Math.round(deg/45) % 8];
    }

    function buildStaticMapURL(lat, lon, width = 1000, height = 500, zoom = 11) {
      const size = `${Math.min(width, 1200)}x${Math.min(height, 800)}`;
      return `https://staticmap.openstreetmap.de/staticmap.php?center=${encodeURIComponent(lat)},${encodeURIComponent(lon)}&zoom=${zoom}&size=${size}&markers=${encodeURIComponent(lat)},${encodeURIComponent(lon)},red-pushpin`;
    }

    async function getWeather() {
      const lat = document.getElementById('lat').value.trim();
      const lon = document.getElementById('lon').value.trim();
      if (!lat || !lon) {
        alert("Please enter both latitude and longitude.");
        return;
      }

      const apiKey = "f430701439c4ab9d557d047cea0d6df6";
      const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&appid=${apiKey}&units=metric`;

      document.getElementById('map').innerHTML = `<iframe width="100%" height="300" src="https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lon)}&output=embed" style="border:0"></iframe>`;

      const staticUrl = buildStaticMapURL(lat, lon, 1000, 500, 11);
      const staticImg = document.getElementById('static-map');
      staticImg.src = staticUrl;
      staticImg.alt = `Map centered at ${lat}, ${lon}`;

      document.getElementById('forecast-table').innerHTML = "";
      document.getElementById('daily-cards').innerHTML = "";
      lastDailySummary = [];

      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('API error ' + resp.status);
        const data = await resp.json();

        const hourlyTbody = document.getElementById('forecast-table');
        const hourlyEntries = (data.list || []).slice(0, 5);
        if (hourlyEntries.length === 0) {
          hourlyTbody.innerHTML = "<tr><td colspan='7'>No hourly data available</td></tr>";
        } else {
          hourlyEntries.forEach(item => {
            const rainChance = Math.round((item.pop || 0) * 100) + "%";
            const precipitation = item.rain && item.rain["3h"] ? item.rain["3h"] : 0;
            const windDir = getWindDirection(item.wind && item.wind.deg);
            const wind = `${item.wind && item.wind.speed ? item.wind.speed : 0} m/s ${windDir}`;
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.dt_txt}</td>
              <td>${item.weather && item.weather[0] ? item.weather[0].description : ''}</td>
              <td>${item.main && item.main.temp != null ? item.main.temp : ''}</td>
              <td>${item.main && item.main.humidity != null ? item.main.humidity : ''}</td>
              <td>${wind}</td>
              <td>${rainChance}</td>
              <td>${precipitation}</td>
            `;
            hourlyTbody.appendChild(row);
          });
        }

        const days = {};
        (data.list || []).forEach(item => {
          const date = item.dt_txt.split(' ')[0];
          if (!days[date]) days[date] = { temps: [], humidity: [], pop: [], weather: [] };
          if (item.main && item.main.temp != null) days[date].temps.push(item.main.temp);
          if (item.main && item.main.humidity != null) days[date].humidity.push(item.main.humidity);
          days[date].pop.push(item.pop || 0);
          if (item.weather && item.weather[0] && item.weather[0].main) days[date].weather.push(item.weather[0].main);
        });

        const dailyKeys = Object.keys(days).slice(0, 5);
        const dailyCards = document.getElementById('daily-cards');

        if (dailyKeys.length === 0) {
          dailyCards.innerHTML = "<p>No daily summary available</p>";
        } else {
          dailyKeys.forEach(date => {
            const d = days[date];
            const avgTemp = d.temps.length ? Math.round(d.temps.reduce((a,b)=>a+b,0)/d.temps.length) : '';
            const avgHumidity = d.humidity.length ? Math.round(d.humidity.reduce((a,b)=>a+b,0)/d.humidity.length) : '';
            const avgPop = d.pop.length ? Math.round((d.pop.reduce((a,b)=>a+b,0)/d.pop.length)*100) : 0;
            const dayName = new Date(date).toLocaleDateString('en-US',{weekday:'long'});
            const freq = {};
            d.weather.forEach(w => { freq[w] = (freq[w]||0)+1; });
            const most = Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0] || '';
            let icon = "‚òÄÔ∏è";
            if (most.includes("Cloud")) icon = "‚òÅÔ∏è";
            if (most.includes("Rain")) icon = "üåßÔ∏è";
            if (most.includes("Storm") || most.includes("Thunder")) icon = "‚õàÔ∏è";
            if (most.includes("Snow")) icon = "‚ùÑÔ∏è";

            lastDailySummary.push({ date, dayName, avgTemp, avgHumidity, avgPop });

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <div class="icon">${icon}</div>
              <h4>${dayName}</h4>
              <p style="font-weight:600">${date}</p>
              <p>Temp: ${avgTemp !== '' ? avgTemp + '¬∞C' : 'N/A'}</p>
              <p>Humidity: ${avgHumidity !== '' ? avgHumidity + '%' : 'N/A'}</p>
              <p>Rain: ${avgPop}%</p>
            `;
            dailyCards.appendChild(card);
          });
        }

      } catch (err) {
        console.error(err);
        document.getElementById('forecast-table').innerHTML = "<tr><td colspan='7'>Error fetching forecast</td></tr>";
        document.getElementById('daily-cards').innerHTML = "<p>Error fetching forecast</p>";
      }
    }

    function downloadCSV() {
      const rows = [];
      const hourlyHeader = ["Time","Cloud Condition","Temperature (¬∞C)","Humidity (%)","Wind","Chance of Rain (%)","Precipitation (mm)"];
      rows.push(hourlyHeader.join(","));
      document.querySelectorAll("#hourly-table tbody tr").forEach(tr => {
        const cols = Array.from(tr.querySelectorAll("td")).map(td => `"${td.innerText.replace(/"/g,'""')}"`);
        rows.push(cols.join(","));
      });
      rows.push("");
      rows.push(["Date","Day","Avg Temp (¬∞C)","Humidity (%)","Chance of Rain (%)"].join(","));
      lastDailySummary.forEach(d => {
        const cols = [
          `"${d.date}"`,
          `"${d.dayName}"`,
          `"${d.avgTemp}"`,
          `"${d.avgHumidity}"`,
          `"${d.avgPop}%"`
        ];
        rows.push(cols.join(","));
      });

      const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.setAttribute("download", "PICOT_Forecast.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    async function downloadPDF() {
      const iframeContainer = document.getElementById('map');
      const staticImg = document.getElementById('static-map');

      if (!staticImg.src) {
        const lat = document.getElementById('lat').value.trim();
        const lon = document.getElementById('lon').value.trim();
        if (lat && lon) staticImg.src = buildStaticMapURL(lat, lon, 1000, 500, 11);
      }

      const originalMapHTML = iframeContainer.innerHTML;
      iframeContainer.style.display = 'none';
      staticImg.style.display = 'block';

      await new Promise(resolve => {
        if (staticImg.complete && staticImg.naturalWidth !== 0) return resolve();
        staticImg.onload = () => resolve();
        staticImg.onerror = () => resolve();
        setTimeout(resolve, 800);
      });

      const element = document.getElementById("report");
      const opt = {
        margin: 0.5,
        filename: 'PICOT_Forecast.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };

      try {
        await html2pdf().set(opt).from(element).save();
      } catch (err) {
        console.error("PDF generation error:", err);
        alert("There was an error generating the PDF. Check the console for details.");
      } finally {
        staticImg.style.display = 'none';
        iframeContainer.style.display = 'block';
        iframeContainer.innerHTML = originalMapHTML;
      }
    }
  </script>
</body>
</html>
